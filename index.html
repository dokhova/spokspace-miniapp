<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/img/favicon.png" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#212121" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Spokspace</title>
    <meta name="title" content="Spokspace" />
    <meta name="description" content="Digital wellbeing ecosystem" />
    <meta property="og:title" content="Spokspace" />
    <meta property="og:site_name" content="Spokspace" />
    <meta property="og:description" content="Digital wellbeing ecosystem" />
    <meta property="og:image" content="/img/logo.jpg" />
    <meta property="og:type" content="website" />
    <meta name="twitter:title" content="Spokspace" />
    <meta name="twitter:description" content="Digital wellbeing ecosystem" />
    <meta name="twitter:image" content="/img/logo.jpg" />

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
      const GA_MEASUREMENT_ID = "%VITE_GA_MEASUREMENT_ID%";
      const TELEGRAM_ANALYTICS_TOKEN = "%VITE_TELEGRAM_ANALYTICS_TOKEN%";
      const TELEGRAM_WEBAPP_AVAILABLE = Boolean(window.Telegram?.WebApp);
      const TELEGRAM_ANALYTICS_ENABLED = Boolean(
        TELEGRAM_ANALYTICS_TOKEN && TELEGRAM_WEBAPP_AVAILABLE,
      );
      const ANALYTICS_ENABLED = Boolean(GA_MEASUREMENT_ID || TELEGRAM_ANALYTICS_ENABLED);

      function loadScript(src, onload) {
        const script = document.createElement("script");
        script.async = true;
        script.src = src;
        if (onload) script.onload = onload;
        document.head.appendChild(script);
      }

      if (GA_MEASUREMENT_ID) {
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          window.dataLayer.push(arguments);
        }
        window.gtag = gtag;
        gtag("js", new Date());
        gtag("config", GA_MEASUREMENT_ID, {
          custom_map: {
            custom_parameter_1: "telegram_user_id",
            custom_parameter_2: "practice_type",
          },
        });
        loadScript(`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`);
      }

      window.telegramAnalyticsReady = false;

      function initAnalytics() {
        if (!TELEGRAM_WEBAPP_AVAILABLE) return;
        if (!window.telegramAnalytics?.init) return;
        window.telegramAnalytics.init({
          token: TELEGRAM_ANALYTICS_TOKEN,
          appName: "spokspace_miniapp",
        });

        window.telegramAnalyticsReady = true;

        if (window.telegramAnalytics && typeof window.telegramAnalytics.track === "function") {
          window.telegramAnalytics.track("app_initialized", {
            timestamp: Date.now(),
            page: "index",
            version: "1.0.0",
          });
        }

        if (window.pendingAnalyticsEvents && window.pendingAnalyticsEvents.length > 0) {
          window.pendingAnalyticsEvents.forEach(({ eventName, parameters }) => {
            trackEvent(eventName, parameters);
          });
          window.pendingAnalyticsEvents = [];
        }
      }

      window.pendingAnalyticsEvents = [];

      function trackEvent(eventName, parameters = {}) {
        if (ANALYTICS_ENABLED) {
          fastAnalytics.track(eventName, parameters);
        }
      }

      class FastAnalytics {
        constructor() {
          this.eventQueue = [];
          this.batchSize = 5;
          this.batchDelay = 1000;
          this.processingBatch = false;

          this.startBatchProcessor();
        }

        track(eventName, parameters = {}) {
          const eventData = {
            eventName,
            parameters: {
              ...parameters,
              timestamp: Date.now(),
              app_name: "spokspace_miniapp",
              page: window.location.pathname,
            },
          };

          this.eventQueue.push(eventData);

          if (this.eventQueue.length >= this.batchSize && !this.processingBatch) {
            this.processBatch();
          }
        }

        startBatchProcessor() {
          setInterval(() => {
            if (this.eventQueue.length > 0 && !this.processingBatch) {
              this.processBatch();
            }
          }, this.batchDelay);
        }

        async processBatch() {
          if (this.processingBatch || this.eventQueue.length === 0) return;

          this.processingBatch = true;
          const batch = this.eventQueue.splice(0, this.batchSize);

          for (const event of batch) {
            await this.sendEvent(event.eventName, event.parameters);
          }

          this.processingBatch = false;
        }

        async sendEvent(eventName, parameters) {
          if (window.telegramAnalyticsReady && window.telegramAnalytics?.track) {
            window.telegramAnalytics.track(eventName, parameters);
          }

          if (typeof gtag !== "undefined") {
            gtag("event", eventName, {
              event_category: "telegram_mini_app",
              event_label: parameters.practice_type || "unknown",
              custom_parameter_1: parameters.user_id,
              custom_parameter_2: parameters.practice_type,
              value: 1,
            });
          }
        }
      }

      const fastAnalytics = new FastAnalytics();

      const rawTgToken = "%VITE_TELEGRAM_ANALYTICS_TOKEN%";
      const tgToken = rawTgToken && !rawTgToken.includes("%") ? rawTgToken : "";

      const isTelegram = !!window.Telegram?.WebApp;
      const TELEGRAM_ANALYTICS_ENABLED = isTelegram && !!tgToken;

      if (TELEGRAM_ANALYTICS_ENABLED) {
        loadScript("https://tganalytics.xyz/index.js", initAnalytics);
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
